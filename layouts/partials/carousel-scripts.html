<!-- Flickity CSS -->
<link rel="stylesheet" href="https://unpkg.com/flickity@2/dist/flickity.min.css">

<!-- Flickity JS -->
<script src="https://unpkg.com/flickity@2/dist/flickity.pkgd.min.js"></script>

<!-- Lightbox CSS -->
<style>
.xandria-lightbox-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.9);
  z-index: 1000;
  display: none;
  align-items: center;
  justify-content: center;
  padding: 20px;
  box-sizing: border-box;
}

.xandria-lightbox-content {
  position: relative;
  width: 95vw;
  height: 95vh;
  background: transparent;
  border-radius: 0;
  overflow: visible;
}

.xandria-lightbox-carousel {
  width: 100%;
  height: 95vh;
  position: relative;
}

.xandria-lightbox-cell {
  width: 100%;
  height: 95vh;
  display: flex;
  align-items: center;
  justify-content: center;
  background: transparent;
}

.xandria-lightbox-cell img {
  max-width: 95vw;
  max-height: 95vh;
  width: auto;
  height: auto;
  object-fit: contain;
  display: block;
  border-radius: 4px;
}

.xandria-lightbox-close {
  position: absolute;
  top: 15px;
  right: 15px;
  background: rgba(0, 0, 0, 0.7);
  color: white;
  border: none;
  border-radius: 50%;
  width: 40px;
  height: 40px;
  font-size: 20px;
  cursor: pointer;
  z-index: 10;
  display: flex;
  align-items: center;
  justify-content: center;
}

.xandria-lightbox-close:hover {
  background: rgba(0, 0, 0, 0.9);
}

.xandria-lightbox-nav {
  position: absolute;
  top: 50%;
  transform: translateY(-50%);
  background: rgba(0, 0, 0, 0.7);
  color: white;
  border: none;
  border-radius: 50%;
  width: 50px;
  height: 50px;
  font-size: 24px;
  cursor: pointer;
  z-index: 10;
  display: flex;
  align-items: center;
  justify-content: center;
}

.xandria-lightbox-nav:hover {
  background: rgba(0, 0, 0, 0.9);
}

.xandria-lightbox-prev {
  left: 15px;
}

.xandria-lightbox-next {
  right: 15px;
}

.xandria-lightbox-info {
  position: absolute;
  bottom: 10px;
  left: 50%;
  transform: translateX(-50%);
  padding: 8px 16px;
  background: rgba(0, 0, 0, 0.7);
  color: white;
  border-radius: 20px;
  text-align: center;
  font-family: 'Open Sans', sans-serif;
  font-size: 14px;
  z-index: 15;
}
</style>

<!-- Custom Carousel JS -->
<script>
document.addEventListener('DOMContentLoaded', function() {
  // Regular carousel initialization
  var carousels = document.querySelectorAll('.property-carousel');
  var flickityInstances = new Map();
  
  carousels.forEach(function(carousel, index) {
    // Skip carousels that are explicitly marked as non-carousel (unavailable listings)
    if (carousel.closest('.property-image-container') && carousel.closest('.property-image-container').classList.contains('no-carousel')) {
      return;
    }
    
    var flickity = new Flickity(carousel, {
      cellAlign: 'left',
      contain: true,
      pageDots: false,
      prevNextButtons: false,
      adaptiveHeight: true
    });

    // Store the flickity instance for later reference
    flickityInstances.set(carousel, flickity);

    var nav = carousel.closest('.property-image-container').querySelector('.carousel-nav');
    if (nav) {
      var prevButton = nav.querySelector('.carousel-prev');
      var nextButton = nav.querySelector('.carousel-next');

      if (prevButton) {
        prevButton.addEventListener('click', function() {
          flickity.previous();
        });
      }

      if (nextButton) {
        nextButton.addEventListener('click', function() {
          flickity.next();
        });
      }
    }

    // Add click handlers for lightbox functionality
    carousel.addEventListener('click', function(e) {
      if (e.target.tagName === 'IMG') {
        e.preventDefault();
        openLightbox(carousel, flickity.selectedIndex);
      }
    });
  });

  // Lightbox functionality
  function openLightbox(carousel, initialIndex) {
    var images = carousel.querySelectorAll('img');
    if (images.length === 0) return;

    // Create lightbox HTML
    var imageElements = Array.from(images).map(img => `
      <div class="xandria-lightbox-cell">
        <img src="${img.src}" alt="${img.alt}">
      </div>
    `).join('');

    var lightboxHtml = `
      <div class="xandria-lightbox-overlay" id="xandria-lightbox">
        <div class="xandria-lightbox-content">
          <button class="xandria-lightbox-close" id="lightbox-close">&times;</button>
          <div class="xandria-lightbox-carousel" id="lightbox-carousel">
            ${imageElements}
          </div>
          <button class="xandria-lightbox-nav xandria-lightbox-prev" id="lightbox-prev">‹</button>
          <button class="xandria-lightbox-nav xandria-lightbox-next" id="lightbox-next">›</button>
          <div class="xandria-lightbox-info">
            <span id="lightbox-counter"></span>
          </div>
        </div>
      </div>
    `;

    // Add lightbox to body
    document.body.insertAdjacentHTML('beforeend', lightboxHtml);
    
    var lightbox = document.getElementById('xandria-lightbox');
    var lightboxCarousel = document.getElementById('lightbox-carousel');
    var counter = document.getElementById('lightbox-counter');
    
    // Show lightbox first
    lightbox.style.display = 'flex';
    document.body.style.overflow = 'hidden';
    
    // Wait a moment for the DOM to be ready, then initialize Flickity
    setTimeout(function() {
      // Initialize lightbox carousel
      var lightboxFlickity = new Flickity(lightboxCarousel, {
        cellAlign: 'center',
        contain: true,
        pageDots: true,
        prevNextButtons: false,
        initialIndex: initialIndex,
        adaptiveHeight: false,
        resize: true
      });

      // Update counter
      function updateCounter() {
        counter.textContent = `${lightboxFlickity.selectedIndex + 1} / ${images.length}`;
      }
      
      updateCounter();
      lightboxFlickity.on('change', updateCounter);

      // Event handlers for navigation
      document.getElementById('lightbox-prev').addEventListener('click', function() {
        lightboxFlickity.previous();
      });
      document.getElementById('lightbox-next').addEventListener('click', function() {
        lightboxFlickity.next();
      });
      
      // Resize the flickity instance after initialization
      lightboxFlickity.resize();
    }, 50);

    // Event handlers for closing
    document.getElementById('lightbox-close').addEventListener('click', closeLightbox);
    
    // Close on overlay click
    lightbox.addEventListener('click', function(e) {
      if (e.target === lightbox) {
        closeLightbox();
      }
    });

    // Close on escape key
    function handleEscape(e) {
      if (e.key === 'Escape') {
        closeLightbox();
        document.removeEventListener('keydown', handleEscape);
      }
    }
    document.addEventListener('keydown', handleEscape);

    function closeLightbox() {
      lightbox.remove();
      document.body.style.overflow = '';
    }
  }
});
</script>
